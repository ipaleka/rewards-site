{% extends "base_generic.html" %}{% load partials %}

{% partialdef labels_form_partial %}
<form method="post"
      hx-post="{% url 'issue-detail' issue.pk %}"
      hx-target="#labels-form-container"
      hx-swap="innerHTML transition:true"
      hx-vals='{"blocking": "true"}'
      class="space-y-4">

    {% csrf_token %}

    <!-- Labels -->
    <div class="flex flex-wrap gap-4">
      {% for checkbox in labels_form.labels %}
      <label class="label cursor-pointer gap-2">
        {{ checkbox.tag }}
        <span class="label-text">{{ checkbox.choice_label }}</span>
      </label>
      {% endfor %}
    </div>

    {{ labels_form.labels.errors }}

    <!-- Priority -->
    <div class="pt-2 border-t border-base-300 flex flex-wrap gap-4">
      {% for radio in labels_form.priority %}
      <label class="label cursor-pointer gap-2">
        {{ radio.tag }}
        <span class="label-text">{{ radio.choice_label }}</span>
      </label>
      {% endfor %}
    </div>

    {{ labels_form.priority.errors }}

    <button type="submit" name="submit_labels" class="btn btn-success btn-sm">
        Set labels
    </button>

</form>
{% endpartialdef labels_form_partial %}

{% partialdef close_modal_partial %}
<dialog id="{{ modal_id }}" class="modal">
  <div class="modal-box">

      <h3 class="font-bold text-lg">{{ action_label }}</h3>
      <p class="py-4">This will close the issue as <strong>{{ action_value }}</strong>.</p>

      <form method="post"
            hx-post="{% url 'issue-detail' issue.pk %}"
            hx-target="body"
            hx-swap="none">

          {% csrf_token %}
          <input type="hidden" name="close_action" value="{{ action_value }}">

          <textarea name="close_comment"
                    class="textarea textarea-bordered w-full h-24 mb-4"
                    placeholder="Comment (optional)..."></textarea>

          <div class="modal-action">
              <button type="button" class="btn" onclick="document.getElementById('{{ modal_id }}').close()">Cancel</button>
              <button type="submit" class="btn {{ btn_class }}">{{ action_label }}</button>
          </div>
      </form>

  </div>

  <form method="dialog" class="modal-backdrop">
      <button>close</button>
  </form>
</dialog>
{% endpartialdef close_modal_partial %}

{% partialdef message_toast %}
<div class="toast toast-top toast-end z-[9999] pr-6 pointer-events-none">

  <div class="alert alert-{{ message.tags|yesno:"error,success" }} shadow-lg pointer-events-auto">

    {% if message.tags == "error" %}
      <svg xmlns="http://www.w3.org/2000/svg"
           class="stroke-current shrink-0 h-6 w-6"
           fill="none"
           viewBox="0 0 24 24">
        <path stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    {% else %}
      <svg xmlns="http://www.w3.org/2000/svg"
           class="stroke-current shrink-0 h-6 w-6"
           fill="none"
           viewBox="0 0 24 24">
        <path stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    {% endif %}

    <span>{{ message }}</span>
  </div>

</div>
{% endpartialdef message_toast %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold mb-6">
      GitHub Issue #{{ issue.number }}
  </h1>

  <div class="pt-4 border-t border-base-300">
    <div class="flex flex-wrap gap-2">
      <a href="{{ issue_html_url }}" target="_blank" class="btn btn-soft btn-sm">View on GitHub</a>

    <!-- Close Issue Buttons - Only for superusers and if GitHub issue is open -->
    {% if user.is_superuser and github_issue and issue_state == 'open' %}
      <button class="btn btn-soft btn-success btn-sm"
              hx-get="{% url 'issue-modal' issue.pk %}?action=addressed"
              hx-target="#modal-container"
              hx-swap="innerHTML transition:true">
        Close as addressed
      </button>

      <button class="btn btn-soft btn-warning btn-sm"
              hx-get="{% url 'issue-modal' issue.pk %}?action=wontfix"
              hx-target="#modal-container"
              hx-swap="innerHTML transition:true">
        Close as wontfix
      </button>
    {% endif %}
    </div>
  </div>

  <!-- Local Issue Information -->
  <div class="card bg-base-100 shadow-md">
    <div class="card-body">
      <div class="space-y-3">
        <p><strong>Number:</strong> {{ issue.number }}</p>
        <p><strong>Status:</strong> {{ issue.status }}</p>
        <!-- Add any other local issue fields you have -->
        <p><strong>Created at:</strong> {{ issue.created_at }}</p>
        <p><strong>Updated at:</strong> {{ issue.updated_at }}</p>      

        {% for contribution in issue.contribution_set.all reversed %}
        <div class="flex items-center gap-2">
          <span class="font-bold">Contribution:</span>
          <a class="link link-accent" href="{{ contribution.get_absolute_url }}">{{ contribution }}</a>
        </div>
        {% endfor %}

      </div>
    </div>
  </div>

  <!-- GitHub Issue Section - Only shown if github_issue or github_error exists -->
  {% if github_issue or github_error %}
  <div class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      {% if github_error %}
        <div class="alert alert-error">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Error fetching GitHub issue: {{ github_error }}</span>
        </div>
      {% elif github_issue %}

        <!-- Add Labels Form - Only for superusers and if GitHub issue is open -->
        {% if user.is_superuser and issue_state == 'open' and labels_form %}
        <div id="labels-form-container" class="mb-6 p-4 bg-base-200 rounded-lg">
            {% partial labels_form_partial %}
        </div>
        {% endif %}

        <!-- Issue Header -->
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 class="text-2xl font-bold flex items-center gap-2">
              {{ issue_title }}
              <span class="badge badge-{% if issue_state == 'open' %}success{% else %}error{% endif %} badge-sm">
                {{ issue_state|title }}
              </span>
            </h2>
            <p class="text-sm text-base-content/70 mt-1">
              #{{ issue.number }} opened on {{ issue_created_at|date:"M j, Y" }}
              {% if issue_updated_at and issue_updated_at != issue_created_at %}
                â€¢ updated on {{ issue_updated_at|date:"M j, Y" }}
              {% endif %}
            </p>
          </div>
        </div>

        <!-- Labels -->
        {% if issue_labels %}
        <div class="mb-4">
          <div class="flex flex-wrap gap-1">
            {% for label in issue_labels %}
            <span class="badge badge-outline badge-sm">{{ label }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Assignees -->
        {% if issue_assignees %}
        <div class="mb-4">
          <p class="text-sm font-medium mb-1">Assignees:</p>
          <div class="flex flex-wrap gap-2">
            {% for assignee in issue_assignees %}
            <span class="badge badge-primary badge-sm">{{ assignee }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Issue Body -->
        <div class="mt-6 pt-6">
          <h3 class="text-lg font-semibold mb-3">Description</h3>
          <div class="prose prose-sm max-w-none bg-base-200 rounded-lg p-4">
            {{ issue_body|linebreaks|urlize }}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Messages -->
  {% for message in messages %}
    {% partial message_toast %}
  {% endfor %}

</div>
<div id="modal-container"></div>
{% endblock %}