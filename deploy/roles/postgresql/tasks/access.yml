---
- name: Tune PostgreSQL for webserver
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: "{{ item.regex }}"
    line: "{{ item.value }}"
    backrefs: true
    state: present
  become: true
  notify: Restart postgresql
  loop:
    - regex: "^#listen_addresses = 'localhost'"
      value: "listen_addresses = '{{ hostvars[inventory_hostname].ansible_host }}'"
  tags: [postgresql, postgresql-access, postgresql-allow-webserver-ip]

- name: Set access rule in pg_hba.conf for webserver
  ansible.builtin.lineinfile:
    path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
    regexp: >
      host\s+{{ global_env_vars['DATABASE_NAME'] }}
      \s+{{ global_env_vars['DATABASE_USER'] }}
      \s+{{ hostvars[inventory_hostname].ansible_host }}/32.*trust
    line: >
      host    {{ global_env_vars['DATABASE_NAME'] }}
              {{ global_env_vars['DATABASE_USER'] }}
              {{ hostvars[inventory_hostname].ansible_host }}/32        trust
    state: present
  become: true
  notify: Restart postgresql
  tags: [postgresql, postgresql-access, postgresql-allow-webserver-ip]

- name: Configure UFW rule for PostgreSQL
  community.general.ufw:
    rule: allow
    to_port: 5432
    proto: any
    from_ip: "{{ hostvars[inventory_hostname].ansible_host }}"
    state: enabled
    comment: "Added for webserver by Ansible"
  become: true
  tags: [postgresql, postgresql-access, postgresql-allow-webserver-ip]
