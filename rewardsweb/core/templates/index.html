{% extends "base_generic.html" %}
{% load partials %}

{% block page_title %}ASA Stats Rewards{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <p class="mt-2 text-lg text-base-content/70">
        Welcome to ASA Stats rewards web!
      </p>
    </div>
    {% if user.is_authenticated %}
    <div class="flex gap-2">
      <span class="badge badge-primary badge-lg">
        <i class="fas fa-user mr-1"></i>
        {{ user.username }}
      </span>
    </div>
    {% endif %}
  </div>

  <!-- Stats Overview Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Cycles Card -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-base-content/70">Total Cycles</p>
          <p class="text-2xl font-bold">{{ num_cycles }}</p>
        </div>
        <div class="p-3 rounded-lg bg-primary/10 text-primary">
          <i class="fas fa-sync-alt text-xl"></i>
        </div>
      </div>
      <p class="text-sm text-info mt-2">
        <i class="fas fa-chart-line mr-1"></i>
        Active reward cycles
      </p>
    </div>

    <!-- Contributors Card -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-base-content/70">Contributors</p>
          <p class="text-2xl font-bold">{{ num_contributors }}</p>
        </div>
        <div class="p-3 rounded-lg bg-secondary/10 text-secondary">
          <i class="fas fa-users text-xl"></i>
        </div>
      </div>
      <p class="text-sm text-success mt-2">
        <i class="fas fa-arrow-up mr-1"></i>
        Community members
      </p>
    </div>

    <!-- Contributions Card -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-base-content/70">Contributions</p>
          <p class="text-2xl font-bold"><span id="contribs-count">{{ num_contributions|floatformat:"g" }}</span></p>
        </div>
        <div class="p-3 rounded-lg bg-accent/10 text-accent">
          <i class="fas fa-tasks text-xl"></i>
        </div>
      </div>
      <p class="text-sm text-warning mt-2">
        <i class="fas fa-code-branch mr-1"></i>
        Total contributions
      </p>
    </div>

    <!-- Total Rewards Card -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-base-content/70">Total Rewards</p>
          <p class="text-2xl font-bold">{{ total_rewards|floatformat:"g" }}</p>
        </div>
        <div class="p-3 rounded-lg bg-success/10 text-success">
          <i class="fas fa-coins text-xl"></i>
        </div>
      </div>
      <p class="text-sm text-success mt-2">
        <i class="fas fa-award mr-1"></i>
        Distributed rewards
      </p>
    </div>
  </div>

  <!-- Two Column Layout for Lower Sections -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Unconfirmed Contributions -->
    <div class="stat-card">
      <div class="flex items-center gap-2 mb-4">
        <i class="fas fa-clock text-warning"></i>
        <h2 class="text-xl font-bold">Unconfirmed Contributions</h2>
      </div>

      {% if contribution_list %}
        <div class="space-y-3">
          {% for contribution in contribution_list %}
          <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
            <a class="link link-accent font-medium" href="{{ contribution.get_absolute_url }}">
              {{ contribution.info }}
            </a>
            <span class="badge badge-warning badge-sm">Pending</span>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8">
          <i class="fas fa-check-circle text-3xl text-success mb-3"></i>
          <p class="text-base-content/70">All contributions are confirmed</p>
        </div>
      {% endif %}
    </div>

    <!-- Claimable Rewards Section -->
    {% if user.profile.contributor and user.profile.contributor.claimable_contributions %}
    <div class="stat-card bg-gradient-to-r from-success/10 to-success/5 border border-success/20">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-3 rounded-lg bg-success/20 text-success">
            <i class="fas fa-gift text-xl"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold text-success">Claimable Rewards Available!</h2>
            <p class="text-base-content/70 mt-1">
              You have {{ user.profile.contributor.claimable_contributions|length }} contribution(s) ready to be claimed.
            </p>
          </div>
        </div>
        <a href="{% url 'claim' %}" class="btn btn-success btn-lg">
          <i class="fas fa-gift mr-2"></i>
          Claim Rewards
        </a>
      </div>
    </div>
    {% endif %}

    <!-- User Active Contributions -->
    {% if user.is_authenticated %}
    <div class="stat-card">
      <div class="flex items-center gap-2 mb-4">
        <i class="fas fa-user-check text-primary"></i>
        <h2 class="text-xl font-bold">
          Your Active Contributions
        </h2>
      </div>
      <div class="mb-4">
        <span class="text-sm text-base-content/70">Contributor: </span>
        <a class="link link-accent font-semibold" href="{{ user.profile.contributor.get_absolute_url }}">
          {{ user.profile }}
        </a>
      </div>

      <div class="space-y-4">
        {% for group in user.profile.contributor.contribution_groups %}
          {% if group.query %}
            {% if group.name == "Open" or group.name == "Addressed" %}
              {% partial contributions %}
            {% endif %}
          {% endif %}
        {% empty %}
          <div class="text-center py-6">
            <i class="fas fa-inbox text-2xl text-base-content/30 mb-2"></i>
            <p class="text-base-content/70">No active contributions</p>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Quick Actions -->
  <div class="stat-card">
    <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
    <div class="flex flex-wrap gap-4">
      <a href="{% url 'cycles' %}" class="btn btn-primary">
        <i class="fas fa-sync-alt mr-2"></i>
        View Cycles
      </a>
      <a href="{% url 'contributors' %}" class="btn btn-secondary">
        <i class="fas fa-users mr-2"></i>
        Browse Contributors
      </a>
      <a href="{% url 'issues' %}" class="btn btn-accent">
        <i class="fas fa-tasks mr-2"></i>
        {% if user.is_superuser %}Manage{% else %}View{% endif %} Issues
      </a>
      {% if not user.is_authenticated %}
      <a href="{% url 'account_login' %}" class="btn btn-outline" hx-boost="false" hx-disable="true">
        <i class="fas fa-sign-in-alt mr-2"></i>
        Login to Contribute
      </a>
      {% endif %}
    </div>
  </div>
</div>

{% partialdef contributions %}
<div class="border-l-4 border-primary pl-4 py-2">
  <div class="flex items-center justify-between mb-3">
    <h3 class="text-lg font-semibold">{{ group.name }} Contributions</h3>
    {% if group.total %}
    <span class="badge badge-primary badge-lg">
      {{ group.total|floatformat:"g" }}
    </span>
    {% endif %}
  </div>
  <div class="space-y-3">
    {% for contribution in group.query reversed %}
    <div class="bg-base-200 rounded-lg p-3 hover:bg-base-300 transition-colors">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
        <div class="flex items-center gap-2">
          <span class="font-semibold text-base-content/70">Cycle:</span>
          <a class="link link-accent font-medium" href="{{ contribution.cycle.get_absolute_url }}">
            {{ contribution.cycle }}
          </a>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-semibold text-base-content/70">Reward:</span>
          <a class="link link-accent font-medium" href="{{ contribution.get_absolute_url }}">
            {{ contribution.reward }}
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endpartialdef contributions %}

{% endblock %}